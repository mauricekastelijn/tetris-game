name: Build Executables

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-executables:
    name: Build Executables (Linux & Windows)
    runs-on: ubuntu-22.04  # Target GLIBC 2.35 - oldest currently supported LTS (20.04 approaching EOL Apr 2025)

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pygame libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Linux executable
        run: |
          echo "Building Linux executable..."
          # Use build_exe.py for consistent builds
          python build_exe.py --clean
          mv dist/tetris dist/tetris-linux
          ls -lh dist/tetris-linux

      - name: Upload Linux executable artifact
        uses: actions/upload-artifact@v6
        with:
          name: tetris-linux
          path: dist/tetris-linux
          retention-days: 30

      - name: Build Windows executable using Wine in Docker
        run: |
          echo "Building Windows executable using cdrx/pyinstaller-windows..."

          # Clean any previous builds
          rm -rf build/ dist/

          # Use cdrx/pyinstaller-windows Docker image which has Wine + Python + PyInstaller pre-configured
          docker run --rm \
            -v "$(pwd):/src" \
            cdrx/pyinstaller-windows:python3 \
            "pip install -r requirements.txt && pyinstaller tetris.spec"

          # The Docker container creates dist/tetris.exe directly when using tetris.spec
          if [ -f "dist/tetris.exe" ]; then
            echo "✓ Windows executable created successfully"
            ls -lh dist/tetris.exe
          else
            echo "✗ Windows executable not found, checking dist/"
            find dist -type f || echo "dist/ directory empty or not found"
            exit 1
          fi

      - name: Upload Windows executable artifact
        uses: actions/upload-artifact@v6
        with:
          name: tetris-windows
          path: dist/tetris.exe
          retention-days: 30

  create-release-assets:
    name: Create Release Assets
    runs-on: ubuntu-latest
    needs: build-executables
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download Linux executable
        uses: actions/download-artifact@v7
        with:
          name: tetris-linux
          path: ./artifacts/linux

      - name: Download Windows executable
        uses: actions/download-artifact@v7
        with:
          name: tetris-windows
          path: ./artifacts/windows

      - name: Create compressed archives
        run: |
          cd artifacts/linux
          chmod +x tetris-linux
          tar -czf ../../tetris-linux-x64.tar.gz tetris-linux
          cd ../windows
          zip ../../tetris-windows-x64.zip tetris.exe
          cd ../..
          ls -lh *.tar.gz *.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            tetris-linux-x64.tar.gz
            tetris-windows-x64.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
